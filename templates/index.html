{% extends "base.html" %}
{% block title %}Smart Planner - Program pe zile{% endblock %}
{% block content %}

<div class="mt-4">
  <h1 class="text-center">Bine ai venit, {{ current_user.username }}!</h1>
</div>
<div class="d-flex justify-content-end mt-2">
  <div class="d-flex flex-column align-items-end gap-2 mb-3">
    {% if current_user.is_authenticated and current_user.role == "admin" %}
        <a href="{{ url_for('admin_panel.dashboard') }}" class="btn btn-warning">
            Admin Panel
        </a>
    {% endif %}
    <a href="/friends" class="btn btn-primary">
        Lista de prieteni
    </a>
</div>
  </a>
</div>
<div class="row justify-content-center mt-4">
  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-body">
        <form class="row g-3 align-items-end" method="get" action="{{ url_for('tasks.view_tasks') }}">
          <div class="col-md-4">
            <label class="form-label">Alege ziua</label>
            <input type="date"
                   class="form-control"
                   name="date"
                   value="{{ selected_date.isoformat() if selected_date else '' }}">
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100 mt-3 mt-md-0">
              Arata programul
            </button>
          </div>
        </form>
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-body">
        <h4 class="mb-3">
          Program pentru
          {% if selected_date %}
            {{ selected_date.strftime('%d.%m.%Y') }}
          {% else %}
            (alege o data)
          {% endif %}
        </h4>
        <div class="card mb-3 stats-card">
          <div class="card-body">
            <div class="row g-3 text-center">
              <div class="col-md-6 col-lg-3">
                <div class="stat-box">
                  <div class="stat-icon">üìÖ</div>
                  <div class="stat-title">Astazi</div>
                  <div class="stat-value">
                    {{ done_today }} / {{ total_today }}
                  </div>
                  <div class="stat-sub">
                    {{ missed_today }} ratate, {{ pending_today }} in asteptare
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-lg-3">
                <div class="stat-box">
                  <div class="stat-icon">üìà</div>
                  <div class="stat-title">Saptamana</div>
                  <div class="stat-value">{{ weekly_rate }}%</div>
                  <div class="stat-sub">rata de finalizare</div>
                </div>
              </div>

              <div class="col-md-6 col-lg-3">
                <div class="stat-box">
                  <div class="stat-icon">‚è∞</div>
                  <div class="stat-title">Cel mai bun interval</div>
                  <div class="stat-value">{{ best_interval }}</div>
                  <div class="stat-sub">cel mai productiv</div>
                </div>
              </div>

              <div class="col-md-6 col-lg-3">
                <div class="stat-box">
                  <div class="stat-icon">üî•</div>
                  <div class="stat-title">Ultimele task-uri</div>
                  <div class="stat-value">{{ done_week }} / {{ week_total }}</div>
                  <div class="stat-sub">finalizate saptamana asta</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {% if tasks and tasks|length > 0 %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width: 20%;">Interval</th>
                  <th>Titlu</th>
                  <th style="width: 10%;" class="text-center">Status</th>
                  <th style="width: 10%;" class="text-end"></th>
                </tr>
              </thead>
              <tbody>
                {% for t in tasks %}
                <tr class="{% if t.status == 'done' %}task-done{% elif t.status == 'missed' %}task-missed{% endif %}">
                 <td>{{ t.start_time.strftime('%H:%M') }} ‚Äì {{ t.end_time.strftime('%H:%M') }}</td>
                 <td>{{ t.title }}</td>

                 <td class="task-actions-cell">
                      <div class="task-actions">
                        <form method="POST" action="{{ url_for('tasks.set_task_status', task_id=t.id, date=selected_date.isoformat()) }}">
                          <input type="hidden" name="status" value="done">
                          <button type="submit" class="btn-done  mark-done">‚úÖ</button>
                        </form>

                        <form method="POST" action="{{ url_for('tasks.set_task_status', task_id=t.id, date=selected_date.isoformat()) }}">
                          <input type="hidden" name="status" value="missed">
                          <button type="submit" class="btn-missed  mark-missed">‚ùå</button>
                        </form>
                      </div>
                 </td>

                 <td class="text-end">
                    <form method="post"
                               action="{{ url_for('tasks.delete_task', task_id=t.id) }}">
                      <input type="hidden" name="date" value="{{ selected_date.isoformat() }}">
                      <button type="submit" class="btn btn-sm btn-outline-danger">
                        Sterge
                      </button>
                   </form>
                 </td>
               </tr>
               {% endfor %}

              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">Nu exista task-uri pentru aceasta zi.</p>
        {% endif %}
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-body">
        <h4 class="mb-3"> Cum vrei sa adaugi taskul?</h4>
        <div class="d-flex gap-3">
          <button type="button"
                  class="btn btn-outline-info w-100"
                  id="btn-rapid">
             Automat
          </button>
          <button type="button"
                  class="btn btn-outline-success w-100"
                  id="btn-normal">
             Manual
          </button>
        </div>
      </div>
    </div>
    <div class="card mb-4 d-none" id="rapid-form">
      <div class="card-body">
        <h4 class="mb-3"> Adaugare rapida</h4>
        <p class="text-muted small"></p>
        <form method="post" action="{{ url_for('tasks.view_tasks') }}">
          <input type="hidden" name="date"
                 value="{{ selected_date.isoformat() if selected_date else '' }}">
          <input type="hidden" name="auto_2pm" value="1">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Titlu</label>
              <input type="text" class="form-control" name="title" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Durata (minute)</label>
              <input type="number" class="form-control" name="duration" min="15" step="15" value="60" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Importanta</label>
              <select name="importance" class="form-control" required>
                <option value="high">Mare</option>
                <option value="medium" selected>Medie</option>
                <option value="low">Mica</option>
              </select>
            </div>
          </div>
          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-info">
               Adauga
            </button>
          </div>
        </form>        
      </div>
    </div>
    <div class="card d-none" id="normal-form">
      <div class="card-body">
        <h4 class="mb-3">Adauga un task nou</h4>
        <form method="post" action="{{ url_for('tasks.view_tasks') }}">
          <input type="hidden" name="date"
                 value="{{ selected_date.isoformat() if selected_date else '' }}">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Ora de start</label>
              <input type="time" class="form-control" name="start" id="startTime" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Ora de final</label>
              <input type="time" class="form-control" name="end" id="endTime" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Importanta</label>
              <select name="importance" class="form-control" required>
                <option value="high">Mare</option>
                <option value="medium">Medie</option>
                <option value="low">Mica</option>
              </select>
            </div>
            <div class="col-md-4" id="low-options" style="display:none;">
              <label class="form-label">Mod pentru importanta mica</label>
              <select name="low_mode" class="form-control">
                <option value="slot">Aleg eu intervalul</option>
                <option value="random">Random</option>
              </select>
            </div>
            <script>
            document.querySelector('select[name="importance"]').addEventListener('change', function () {
                let lowOptions = document.getElementById("low-options");
                lowOptions.style.display = this.value === "low" ? "block" : "none";
            });
            </script>
            <div class="col-md-6">
              <label class="form-label">Titlu</label>
              <input type="text" class="form-control" name="title" id="taskTitle" required>
            </div>
          </div>
          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-success">Salveaza task</button>
          </div>
        </form>        
      </div>
      {% if top_tasks and top_tasks|length > 0 %}
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="mb-3">Task-uri frecvente</h5>
          <div class="d-flex gap-2 flex-wrap">
            {% for t in top_tasks %}
            <button type="button"
                    class="btn btn-outline-primary shortcut"
                    data-title="{{ t.title }}"
                    data-duration="{{ t.avg_duration|round(0) }}"
                    data-importance="medium">
               {{ t.title }}
            </button>
            {% endfor %}
          </div>
        </div>
      </div>
  {% endif %}
  <h5 class="mb-2">Sugestii</h5>
  <div class="d-flex flex-wrap gap-2 mb-3">
    <button type="button" class="btn btn-outline-primary template-btn"
            data-title="Facultate"
            data-duration="120"
            data-importance="high">
      Facultate (2h)
    </button>
    <button type="button" class="btn btn-outline-success template-btn"
            data-title="Antrenament"
            data-duration="90"
            data-importance="medium">
      Antrenament (1h 30m)
    </button>
    <button type="button" class="btn btn-outline-info template-btn"
            data-title="Curatenie"
            data-duration="45"
            data-importance="low">
      Curatenie (45m)
    </button>
  </div>
    </div>
  </div>
</div>
<div class="text-center mt-5">
    <a href="/logout" class="btn btn-danger btn-lgout">Logout</a>
</div>
<style>
.btn-lgout{
    position:fixed;
    bottom:20px;
    right:20px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const shortcuts = document.querySelectorAll(".shortcut");
    const titleInput = document.getElementById("taskTitle");
    const startInput = document.getElementById("startTime");
    const endInput = document.getElementById("endTime");
    const importanceSelect = document.querySelector("select[name='importance']");
    shortcuts.forEach(btn => {
        btn.addEventListener("click", () => {
            let title = btn.dataset.title;
            let duration = parseInt(btn.dataset.duration);
            let importance = btn.dataset.importance || "medium";
            titleInput.value = title;
            importanceSelect.value = importance;
            importanceSelect.dispatchEvent(new Event("change"));
            if (startInput.value) {
                let [h, m] = startInput.value.split(":").map(Number);
                let total = h * 60 + m + duration;
                let endH = Math.floor(total / 60);
                let endM = total % 60;
                endInput.value = 
                    String(endH).padStart(2, '0') + ":" +
                    String(endM).padStart(2, '0');
            }
            btn.classList.add("btn-success");
            setTimeout(() => btn.classList.remove("btn-success"), 800);
        });
    });
    startInput.addEventListener("input", () => {
        let shortcut = document.querySelector(".shortcut.btn-success");
        if (!shortcut) return;
        let duration = parseInt(shortcut.dataset.duration);
        let [h, m] = startInput.value.split(":").map(Number);
        let total = h * 60 + m + duration;
        let endH = Math.floor(total / 60);
        let endM = total % 60;
        endInput.value =
            String(endH).padStart(2, '0') + ":" +
            String(endM).padStart(2, '0');
    });
});
</script>

<script>
setTimeout(() => {
    document.querySelectorAll('.flash-msg').forEach(el => {
        el.style.transition = "opacity 0.5s";
        el.style.opacity = "0";
        setTimeout(() => el.remove(), 500); 
    });
}, 3000); 
</script>

<script>
const smartRules = [
    { keywords: ["sala", "gym", "antrenament"], duration: 90, importance: "medium", low_mode: "slot" },
    { keywords: ["facultate", "tema", "proiect"], duration: 120, importance: "high", low_mode: "slot" },
    { keywords: ["citit"], duration: 45, importance: "low", low_mode: "slot" },
    { keywords: ["invata", "invatat", "examen"], duration: 120, importance: "high", low_mode: "slot" },
    { keywords: ["curatenie", "curat"], duration: 60, importance: "low", low_mode: "random" }
];

function addMinutes(timeStr, mins) {
    let [h, m] = timeStr.split(":").map(Number);
    let total = h * 60 + m + mins;
    return String(Math.floor(total / 60)).padStart(2, "0") + ":" +
           String(total % 60).padStart(2, "0");
}

document.getElementById("taskTitle").addEventListener("input", function () {
    let text = this.value.toLowerCase();
    for (let rule of smartRules) {
        if (rule.keywords.some(k => text.includes(k))) {
            let startInput = document.getElementById("startTime");
            let endInput = document.getElementById("endTime");
            if (startInput.value) {
                endInput.value = addMinutes(startInput.value, rule.duration);
            }
            document.querySelector('select[name="importance"]').value = rule.importance;
            let lowModeSelect = document.querySelector('select[name="low_mode"]');
            if (lowModeSelect) lowModeSelect.value = rule.low_mode;
            break;
        }
    }
});
</script>

<script>
const btnRapid = document.getElementById("btn-rapid");
const btnNormal = document.getElementById("btn-normal");
const rapidForm = document.getElementById("rapid-form");
const normalForm = document.getElementById("normal-form");
btnRapid.addEventListener("click", () => {
    rapidForm.classList.remove("d-none");
    normalForm.classList.add("d-none");
    btnRapid.classList.add("btn-info");
    btnRapid.classList.remove("btn-outline-info");
    btnNormal.classList.add("btn-outline-success");
    btnNormal.classList.remove("btn-success");
});
btnNormal.addEventListener("click", () => {
    normalForm.classList.remove("d-none");
    rapidForm.classList.add("d-none");
    btnNormal.classList.add("btn-success");
    btnNormal.classList.remove("btn-outline-success");
    btnRapid.classList.add("btn-outline-info");
    btnRapid.classList.remove("btn-info");
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  function markRow(btn, clsToAdd, clsToRemove) {
    const row = btn.closest("tr");
    if (!row) return;

    row.classList.remove(clsToRemove);
    row.classList.add(clsToAdd);

    setTimeout(() => {
      btn.closest("form").submit();
    }, 150);
  }

  document.querySelectorAll(".mark-done").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      markRow(btn, "task-done", "task-missed");
    });
  });

  document.querySelectorAll(".mark-missed").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      markRow(btn, "task-missed", "task-done");
    });
  });
});
</script>



{% endblock %}