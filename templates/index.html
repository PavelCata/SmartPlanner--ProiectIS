{% extends "base.html" %}
{% block title %}Smart Planner - Program pe zile{% endblock %}
{% block content %}

<div class="mt-4">
  <h1 class="text-center">Bine ai venit, {{ current_user.username }}!</h1>
</div>
<div class="d-flex justify-content-end mt-2">
  <a href="{{ url_for('friends.list_friends') }}" 
     class="btn btn-primary btn-sm">
     Lista de prieteni
  </a>
</div>

<div class="row justify-content-center mt-4">
  <div class="col-lg-8">

    <div class="card mb-4">
      <div class="card-body">
        <form class="row g-3 align-items-end" method="get" action="{{ url_for('tasks.view_tasks') }}">
          <div class="col-md-4">
            <label class="form-label">Alege ziua</label>
            <input type="date"
                   class="form-control"
                   name="date"
                   value="{{ selected_date.isoformat() if selected_date else '' }}">
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100 mt-3 mt-md-0">
              Arata programul
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h4 class="mb-3">
          Program pentru
          {% if selected_date %}
            {{ selected_date.strftime('%d.%m.%Y') }}
          {% else %}
            (alege o data)
          {% endif %}
        </h4>

        {% if tasks and tasks|length > 0 %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width: 20%;">Interval</th>
                  <th>Titlu</th>
                  <th style="width: 10%;"></th>
                </tr>
              </thead>
              <tbody>
                {% for t in tasks %}
                  <tr>
                    <td>{{ t.start_time.strftime('%H:%M') }} â€“ {{ t.end_time.strftime('%H:%M') }}</td>
                    <td>{{ t.title }}</td>
                    <td class="text-end">
                      <form method="post"
                            action="{{ url_for('tasks.delete_task', task_id=t.id) }}">
                        <input type="hidden" name="date" value="{{ selected_date.isoformat() }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          Sterge
                        </button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">Nu exista task-uri pentru aceasta zi.</p>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h4 class="mb-3">Adauga un task nou</h4>
        <form method="post" action="{{ url_for('tasks.view_tasks') }}">
          <input type="hidden" name="date"
                 value="{{ selected_date.isoformat() if selected_date else '' }}">

          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Ora de start</label>
              <input type="time" class="form-control" name="start" id="startTime" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Ora de final</label>
              <input type="time" class="form-control" name="end" id="endTime" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Importanta</label>
              <select name="importance" class="form-control" required>
                <option value="high">Mare</option>
                <option value="medium">Medie</option>
                <option value="low">Mica</option>
              </select>
            </div>
            <div class="col-md-4" id="low-options" style="display:none;">
              <label class="form-label">Mod pentru importanta mica</label>
              <select name="low_mode" class="form-control">
                <option value="slot">Aleg eu intervalul</option>
                <option value="random">Random</option>
              </select>
            </div>
            <script>
            document.querySelector('select[name="importance"]').addEventListener('change', function () {
                let lowOptions = document.getElementById("low-options");
                lowOptions.style.display = this.value === "low" ? "block" : "none";
            });
            </script>

            <div class="col-md-6">
              <label class="form-label">Titlu</label>
              <input type="text" class="form-control" name="title" id="taskTitle" required>
            </div>
          </div>

          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-success">Salveaza task</button>
          </div>
        </form>

        
      </div>
    </div>

  </div>
</div>

<div class="text-center mt-5">
    <a href="/logout" class="btn btn-danger btn-lgout">Logout</a>
</div>

<style>
.btn-lgout{
    position:fixed;
    bottom:20px;
    right:20px;
}
</style>
{% if request.endpoint == "home.index" %}
  {% if next_task %}
  <div class = "alert alert-warning mb-3 text-center flash-msg">
    Grabeste-te, task-ul "{{ next_task.title }}" expira la {{ next_task.end_time.strftime('%H:%M') }}!
  </div>
  {% else %}
  <div class = "alert alert-success mb-3 text-center flash-msg">
    Nu mai ai taskuri pentru azi!
  </div>
  {% endif %}
{% endif %}

<script>
setTimeout(() => {
    document.querySelectorAll('.flash-msg').forEach(el => {
        el.style.transition = "opacity 0.5s";
        el.style.opacity = "0";
        setTimeout(() => el.remove(), 500); 
    });
}, 3000); 
</script>

<script>
const smartRules = [
    { keywords: ["sala", "gym", "antrenament"], duration: 90, importance: "medium", low_mode: "slot" },
    { keywords: ["facultate", "tema", "proiect"], duration: 120, importance: "high", low_mode: "slot" },
    { keywords: ["citit"], duration: 45, importance: "low", low_mode: "slot" },
    { keywords: ["invata", "invatat", "examen"], duration: 120, importance: "high", low_mode: "slot" },
    { keywords: ["curatenie", "curat"], duration: 60, importance: "low", low_mode: "random" }
];

function addMinutes(timeStr, mins) {
    let [h, m] = timeStr.split(":").map(Number);
    let total = h * 60 + m + mins;
    return String(Math.floor(total / 60)).padStart(2, "0") + ":" +
           String(total % 60).padStart(2, "0");
}

document.getElementById("taskTitle").addEventListener("input", function () {
    let text = this.value.toLowerCase();
    for (let rule of smartRules) {
        if (rule.keywords.some(k => text.includes(k))) {
            let startInput = document.getElementById("startTime");
            let endInput = document.getElementById("endTime");
            if (startInput.value) {
                endInput.value = addMinutes(startInput.value, rule.duration);
            }
            document.querySelector('select[name="importance"]').value = rule.importance;
            let lowModeSelect = document.querySelector('select[name="low_mode"]');
            if (lowModeSelect) lowModeSelect.value = rule.low_mode;
            break;
        }
    }
});
</script>

{% endblock %}